<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema de Envíos - Guías y Pedidos (Local)</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Google Fonts: Roboto Mono -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">

  <!-- jsPDF para exportar PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* ---------- Tema y tipografías ---------- */
    :root{
      --bg: #e9eef3;
      --card: #ffffff;
      --muted: #475569;
      --accent: #0ea5a4;
      --border: rgba(0,0,0,0.08);
      --text: #0f172a;
    }
    html,body{
      background:var(--bg);
      color:var(--text);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Tarjetas */
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      box-shadow:0 4px 10px rgba(0,0,0,0.05);
      transition: transform .18s ease;
    }
    .card:hover{ transform: translateY(-3px); }

    /* Navbar y botones primarios */
    .navbar, .btn-primary{
      background: linear-gradient(90deg, #0ea5a4, #06b6d4) !important;
      border: 0;
      color: #fff !important;
    }
    .btn-primary:hover { opacity: .95; }

    .muted { color:var(--muted); }
    .small-muted { font-size:.9rem; color:var(--muted); }

    /* Inputs */
    .form-control, .form-select {
      background:#f8fafc;
      color:var(--text);
      border:1.5px solid var(--accent);
      border-radius:8px;
      padding:.6rem .75rem;
    }

    /* Tabla / contenedor de guías: limitar altura y scroll */
    .table {
      color:var(--text);
      background:#fff;
      border-radius:8px;
      overflow:hidden;
    }
    .table thead th { background:#f1f5f9; border-bottom: 2px solid var(--border); }
    .table-striped > tbody > tr:nth-of-type(odd) { background-color: #f8fafc; }

    /* Nuevo: caja con altura máxima para la lista de guías */
    .guias-box {
      max-height: 360px;        /* <--- ajusta esta altura si quieres más/menos */
      overflow-y: auto;
      padding-right: 8px;       /* espacio para scrollbar */
    }
    /* Mantener las filas visibles y accesibles */
    .guias-box table { margin-bottom: 0; }

    .badge-status { padding:.4rem .6rem; border-radius:.5rem; font-weight:600; font-size:.85rem; }
    .status-pend { background:#fbbf24; color:#1e293b; }
    .status-trans { background:#38bdf8; color:#082f49; }
    .status-ent { background:#34d399; color:#064e3b; }

    .btn-ghost { background:transparent; border:1px solid var(--border); color:var(--text); }

    footer { opacity:.7; font-size:.85rem; text-align:center; margin-top:2rem; }

    .mono { font-family: ui-monospace, "Roboto Mono", monospace; }

    /* Pequeño ajuste responsive */
    @media (max-width: 768px) {
      .guias-box { max-height: 280px; }
    }
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="navbar navbar-expand-lg mb-4">
    <div class="container-fluid">
      <a class="navbar-brand text-white ms-2" href="#"><i class="bi bi-box-seam-fill"></i> Envíos Local</a>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-light text-dark" id="btn-seed">Cargar ejemplo</button>
        <button class="btn btn-sm btn-light text-dark" id="btn-backup">Exportar JSON</button>
        <button class="btn btn-sm btn-light text-dark" id="btn-restore">Importar JSON</button>
        <button class="btn btn-sm btn-light text-dark" onclick="logout()">Cerrar sesión</button>
        <button class="btn btn-sm" id="btn-clear" title="Vaciar base de datos" style="background:#7f1d1d;color:#fff;"><i class="bi bi-trash"></i></button>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="row g-3">

      <!-- LEFT: Form crear guía -->
      <div class="col-lg-4">
        <div class="card p-3">
          <h5 class="mb-3">Crear / Editar Guía</h5>
          <form id="form-guia" autocomplete="off">
            <input type="hidden" id="guia-id" value="">
            <div class="mb-2">
              <label class="form-label small-muted">Número de guía</label>
              <input id="guia-num" class="form-control" required placeholder="Ej: GUA-2025-0001">
            </div>
            <div class="row">
              <div class="col-6 mb-2">
                <label class="form-label small-muted">Remitente</label>
                <input id="guia-rem" class="form-control" required placeholder="Nombre remitente">
              </div>
              <div class="col-6 mb-2">
                <label class="form-label small-muted">Destinatario</label>
                <input id="guia-dest" class="form-control" required placeholder="Nombre destinatario">
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label small-muted">Dirección entrega</label>
              <input id="guia-dir" class="form-control" placeholder="Dirección completa">
            </div>
            <div class="row">
              <div class="col-6 mb-2">
                <label class="form-label small-muted">Peso (kg)</label>
                <input id="guia-peso" type="number" step="0.01" class="form-control" placeholder="0.5">
              </div>
              <div class="col-6 mb-2">
                <label class="form-label small-muted">Estado</label>
                <select id="guia-estado" class="form-select">
                  <option value="Pendiente">Pendiente</option>
                  <option value="En tránsito">En tránsito</option>
                  <option value="Entregado">Entregado</option>
                </select>
              </div>
            </div>

            <div class="mb-2">
              <label class="form-label small-muted">Observaciones</label>
              <textarea id="guia-obs" class="form-control" rows="2" placeholder="Notas internas..."></textarea>
            </div>

            <div class="d-flex gap-2">
              <button class="btn btn-primary" id="btn-save-guia">Guardar guía</button>
              <button type="button" class="btn btn-ghost" id="btn-reset">Limpiar</button>
            </div>
            <div class="mt-3">
              <small class="muted">Cada guía puede contener varios pedidos (items). Guarda la guía y luego agrégale pedidos en la ficha.</small>
            </div>
          </form>
        </div>

        <!-- Quick stats -->
        <div class="card p-3 mt-3">
          <h6 class="mb-2">Resumen</h6>
          <div class="d-flex justify-content-between">
            <div>
              <div class="small-muted">Total guías</div>
              <div id="stat-total" class="h4 mono">0</div>
            </div>
            <div>
              <div class="small-muted">Pendientes</div>
              <div id="stat-pend" class="h4 mono">0</div>
            </div>
            <div>
              <div class="small-muted">En tránsito</div>
              <div id="stat-trans" class="h4 mono">0</div>
            </div>
            <div>
              <div class="small-muted">Entregadas</div>
              <div id="stat-ent" class="h4 mono">0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Listado y ficha -->
      <div class="col-lg-8">
        <!-- Search and filter -->
        <div class="card p-3 mb-3">
          <div class="d-flex gap-2 align-items-center">
            <input id="search" class="form-control" placeholder="Buscar por número guía, remitente, destinatario, dirección...">
            <select id="filter-estado" class="form-select" style="max-width:200px">
              <option value="">Todos los estados</option>
              <option value="Pendiente">Pendiente</option>
              <option value="En tránsito">En tránsito</option>
              <option value="Entregado">Entregado</option>
            </select>
            <button class="btn btn-ghost" id="btn-new">Nueva guía</button>
          </div>
        </div>

        <!-- Tabla de guías -->
        <div class="card p-3 mb-3">
          <h6>Guías registradas</h6>
          <div class="mt-2 guias-box">
            <!-- guias-box limita la altura y agrega scroll vertical -->
            <div class="table-responsive">
              <table class="table table-borderless table-hover align-middle" id="tabla-guias">
                <thead>
                  <tr class="muted">
                    <th>N° Guía</th>
                    <th>Remitente</th>
                    <th>Destinatario</th>
                    <th>Peso</th>
                    <th>Estado</th>
                    <th class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody id="body-guias">
                  <!-- Rows dinámicas -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Ficha guía -->
        <div class="card p-3" id="ficha-container" style="display:none;">
          <div class="d-flex justify-content-between">
            <div>
              <h5 id="ficha-num">Guía</h5>
              <div class="small-muted" id="ficha-fecha">Fecha</div>
            </div>
            <div class="text-end">
              <button class="btn btn-sm btn-light me-1" id="btn-export-pdf"><i class="bi bi-file-earmark-pdf"></i> Exportar PDF</button>
              <button class="btn btn-sm btn-light" id="btn-print"><i class="bi bi-printer"></i> Imprimir</button>
            </div>
          </div>

          <hr class="my-2">

          <div class="row">
            <div class="col-md-6">
              <div><strong>Remitente:</strong> <span id="ficha-rem"></span></div>
              <div><strong>Dirección:</strong> <span id="ficha-dir"></span></div>
              <div><strong>Observaciones:</strong> <span id="ficha-obs"></span></div>
            </div>
            <div class="col-md-6">
              <div><strong>Destinatario:</strong> <span id="ficha-dest"></span></div>
              <div><strong>Peso:</strong> <span id="ficha-peso"></span> kg</div>
              <div><strong>Estado:</strong> <span id="ficha-estado" class="badge-status"></span></div>
            </div>
          </div>

          <hr>

          <!-- Pedidos -->
          <div class="mb-3">
            <h6 class="d-flex justify-content-between">
              <span>Pedidos / Items</span>
              <button class="btn btn-sm btn-primary" id="btn-add-item"><i class="bi bi-plus"></i> Añadir pedido</button>
            </h6>

            <div id="items-list" class="mt-2">
              <!-- items dinámicos -->
            </div>
          </div>

          <div class="d-flex gap-2 justify-content-end">
            <button class="btn btn-danger" id="btn-delete-guia"><i class="bi bi-trash"></i> Eliminar guía</button>
            <button class="btn btn-ghost" id="btn-close-ficha">Cerrar ficha</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <footer class="container mt-4 pb-4">
    <div class="d-flex justify-content-between">
      <div>© Sistema de Envíos - Local · Diseñado para uso en un solo equipo</div>
      <div class="muted">IndexedDB · Sin servidor · Archivo único</div>
    </div>
  </footer>

  <!-- Modal: Añadir / Editar item -->
  <div class="modal fade" id="modalItem" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header">
          <h5 class="modal-title">Agregar pedido</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <form id="form-item">
            <input type="hidden" id="item-id" value="">
            <div class="mb-2">
              <label class="form-label small-muted">Descripción</label>
              <input id="item-desc" class="form-control" required placeholder="Ej: Caja electrónica">
            </div>
            <div class="mb-2">
              <label class="form-label small-muted">Cantidad</label>
              <input id="item-cant" type="number" min="1" value="1" class="form-control" required>
            </div>
            <div class="mb-2">
              <label class="form-label small-muted">Valor (opcional)</label>
              <input id="item-valor" type="number" step="0.01" class="form-control" placeholder="0.00">
            </div>
            <div class="mb-2">
              <label class="form-label small-muted">Peso (kg) (opcional)</label>
              <input id="item-peso" type="number" step="0.01" class="form-control" placeholder="0.2">
            </div>
            <div class="text-end">
              <button class="btn btn-primary">Guardar pedido</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- JS: Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  /**
   * archivo: index.html (mejorado - fase 1)
   * Objetivo: Mejorar estructura y legibilidad sin cambiar la lógica.
   * Conserva: IndexedDB, export/import JSON, PDF, CRUD guías y pedidos, modal.
   */

  (function(){
    'use strict';

    /* ==========================
       Constantes y variables DB
       ========================== */
    const DB_NAME = 'envios_db_v1';
    const DB_VERSION = 1;
    let db;

    /* ==========================
       Helpers: DOM shortcuts
       ========================== */
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    /* ==========================
       IndexedDB: wrapper simple
       ========================== */
    function openDB(){
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = (e) => {
          const idb = e.target.result;
          if (!idb.objectStoreNames.contains('guias')) {
            const store = idb.createObjectStore('guias', { keyPath: 'id', autoIncrement: true });
            store.createIndex('num', 'numero', { unique: true });
            store.createIndex('rem', 'remitente', { unique: false });
            store.createIndex('dest', 'destinatario', { unique: false });
            store.createIndex('estado', 'estado', { unique: false });
          }
        };
        req.onsuccess = (e) => { db = e.target.result; resolve(db); };
        req.onerror = (e) => reject(e);
      });
    }

    function tx(storeName, mode='readonly'){
      const t = db.transaction(storeName, mode);
      return t.objectStore(storeName);
    }

    function addGuia(guia){
      return new Promise((res, rej) => {
        const store = tx('guias','readwrite');
        const req = store.add(guia);
        req.onsuccess = () => res(req.result);
        req.onerror = (e) => rej(e);
      });
    }

    function putGuia(guia){
      return new Promise((res, rej) => {
        const store = tx('guias','readwrite');
        const req = store.put(guia);
        req.onsuccess = () => res(req.result);
        req.onerror = (e) => rej(e);
      });
    }

    function deleteGuia(id){
      return new Promise((res, rej) => {
        const store = tx('guias','readwrite');
        const req = store.delete(Number(id));
        req.onsuccess = () => res(true);
        req.onerror = (e) => rej(e);
      });
    }

    function getAllGuias(){
      return new Promise((res, rej) => {
        const store = tx('guias','readonly');
        const req = store.getAll();
        req.onsuccess = () => res(req.result || []);
        req.onerror = (e) => rej(e);
      });
    }

    function getGuiaById(id){
      return new Promise((res, rej) => {
        const store = tx('guias','readonly');
        const req = store.get(Number(id));
        req.onsuccess = () => res(req.result);
        req.onerror = (e) => rej(e);
      });
    }

    /* ==========================
       Document ready: bind y carga inicial
       ========================== */
    let bsModalItem;
    document.addEventListener('DOMContentLoaded', async () => {
      await openDB();
      bsModalItem = new bootstrap.Modal($('#modalItem'), { backdrop: 'static' });
      bindEvents();
      await refreshTabla();
      await updateStats();
    });

    /* ==========================
       Bind de eventos
       ========================== */
    function bindEvents(){
      $('#form-guia').addEventListener('submit', onSaveGuia);
      $('#btn-reset').addEventListener('click', resetForm);
      $('#btn-new').addEventListener('click', ()=>{ resetForm(); window.scrollTo({top:0, behavior:'smooth'}); });
      $('#search').addEventListener('input', refreshTabla);
      $('#filter-estado').addEventListener('change', refreshTabla);
      $('#btn-close-ficha').addEventListener('click', ()=> $('#ficha-container').style.display = 'none');
      $('#btn-delete-guia').addEventListener('click', onDeleteGuia);
      $('#btn-add-item').addEventListener('click', ()=> openItemModal());
      $('#form-item').addEventListener('submit', onSaveItem);
      $('#btn-export-pdf').addEventListener('click', exportPDFCurrent);
      $('#btn-print').addEventListener('click', () => window.print());
      $('#btn-seed').addEventListener('click', seedDemo);
      $('#btn-backup').addEventListener('click', exportJSON);
      $('#btn-restore').addEventListener('click', ()=> {
        const f = document.createElement('input');
        f.type = 'file'; f.accept = '.json,application/json';
        f.onchange = async (e) => {
          const file = e.target.files[0];
          const txt = await file.text();
          await importJSON(txt);
          await refreshTabla();
        };
        f.click();
      });
      $('#btn-clear').addEventListener('click', async ()=> {
        if (!confirm('¿Eliminar toda la base de datos local? Esta acción NO tiene vuelta atrás.')) return;
        const r = indexedDB.deleteDatabase(DB_NAME);
        r.onsuccess = () => { alert('Base de datos eliminada. Recarga la página.'); location.reload(); };
        r.onerror = () => alert('No se pudo eliminar la base de datos.');
      });
    }

    /* ==========================
       Guardar / Actualizar guía
       ========================== */
    async function onSaveGuia(e){
      e.preventDefault();
      const id = $('#guia-id').value;
      const numero = $('#guia-num').value.trim();
      const remitente = $('#guia-rem').value.trim();
      const destinatario = $('#guia-dest').value.trim();
      const direccion = $('#guia-dir').value.trim();
      const peso = parseFloat($('#guia-peso').value || 0);
      const estado = $('#guia-estado').value;
      const obs = $('#guia-obs').value;

      if (!numero || !remitente || !destinatario) { alert('Número, remitente y destinatario son obligatorios.'); return; }

      const now = new Date().toISOString();

      if (id) {
        // update existente
        const g = await getGuiaById(Number(id));
        g.numero = numero;
        g.remitente = remitente;
        g.destinatario = destinatario;
        g.direccion = direccion;
        g.peso = peso;
        g.estado = estado;
        g.obs = obs;
        g.updated_at = now;
        await putGuia(g);
        alert('Guía actualizada.');
        await loadFicha(g.id);
      } else {
        // nueva guía
        const guia = { numero, remitente, destinatario, direccion, peso, estado, obs, pedidos: [], created_at: now, updated_at: now };
        try {
          const newId = await addGuia(guia);
          alert('Guía creada con ID ' + newId);
          resetForm();
        } catch (err) {
          // ConstraintError -> número duplicado (índice unique)
          if (err && err.target && err.target.error && /ConstraintError/.test(err.target.error.name)) {
            alert('Ya existe una guía con ese número. Use otro número.');
          } else {
            alert('Error al crear la guía.');
            console.error(err);
          }
        }
      }
      await refreshTabla();
      await updateStats();
    }

    function resetForm(){
      $('#guia-id').value = '';
      $('#guia-num').value = '';
      $('#guia-rem').value = '';
      $('#guia-dest').value = '';
      $('#guia-dir').value = '';
      $('#guia-peso').value = '';
      $('#guia-estado').value = 'Pendiente';
      $('#guia-obs').value = '';
    }

    /* ==========================
       Listado y filtros (tabla)
       ========================== */
    async function refreshTabla(){
      const q = $('#search').value.toLowerCase();
      const estadoFilter = $('#filter-estado').value;
      const list = await getAllGuias();
      const tbody = $('#body-guias');
      tbody.innerHTML = '';

      const filtered = list.filter(g => {
        const text = (g.numero + ' ' + g.remitente + ' ' + g.destinatario + ' ' + (g.direccion||'')).toLowerCase();
        if (estadoFilter && g.estado !== estadoFilter) return false;
        if (q && !text.includes(q)) return false;
        return true;
      }).sort((a,b) => b.id - a.id);

      for (const g of filtered) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${escapeHtml(g.numero)}</td>
          <td>${escapeHtml(g.remitente)}</td>
          <td>${escapeHtml(g.destinatario)}</td>
          <td>${g.peso || '-'}</td>
          <td>${renderEstado(g.estado)}</td>
          <td class="text-end">
            <div class="btn-group" role="group">
              <button class="btn btn-sm btn-light" data-id="${g.id}" onclick="openFicha(${g.id})"><i class="bi bi-eye"></i></button>
              <button class="btn btn-sm btn-ghost" data-id="${g.id}" onclick="editGuia(${g.id})"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-sm btn-danger" data-id="${g.id}" onclick="confirmDelete(${g.id}, '${escapeQuotes(g.numero)}')"><i class="bi bi-trash"></i></button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    /* ==========================
       Helpers de escape / render
       ========================== */
    function escapeHtml(s=''){
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function escapeQuotes(s=''){ return String(s).replace(/'/g,"\\'").replace(/"/g,'\\"'); }

    function renderEstado(estado){
      if (!estado) return '';
      if (estado === 'Pendiente') return '<span class="badge-status status-pend">Pendiente</span>';
      if (estado === 'En tránsito') return '<span class="badge-status status-trans">En tránsito</span>';
      if (estado === 'Entregado') return '<span class="badge-status status-ent">Entregado</span>';
      return `<span class="badge-status">${escapeHtml(estado)}</span>`;
    }

    /* ==========================
       Editar / eliminar desde tabla
       ========================== */
    async function editGuia(id){
      const g = await getGuiaById(id);
      if (!g) return alert('Guía no encontrada');
      $('#guia-id').value = g.id;
      $('#guia-num').value = g.numero;
      $('#guia-rem').value = g.remitente;
      $('#guia-dest').value = g.destinatario;
      $('#guia-dir').value = g.direccion || '';
      $('#guia-peso').value = g.peso || '';
      $('#guia-estado').value = g.estado || 'Pendiente';
      $('#guia-obs').value = g.obs || '';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function confirmDelete(id, numero){
      if (!confirm('¿Eliminar la guía ' + numero + ' (ID ' + id + ')?')) return;
      await deleteGuia(id);
      alert('Guía eliminada.');
      await refreshTabla();
      await updateStats();
    }

    /* ==========================
       Ficha detallada (abrir / render)
       ========================== */
    async function openFicha(id){
      await loadFicha(id);
      $('#ficha-container').style.display = 'block';
      window.scrollTo({ top: $('#ficha-container').offsetTop - 20, behavior: 'smooth' });
    }

    async function loadFicha(id){
      const g = await getGuiaById(Number(id));
      if (!g) return alert('Guía no encontrada.');
      $('#ficha-num').innerText = g.numero;
      $('#ficha-fecha').innerText = 'Creada: ' + (g.created_at ? new Date(g.created_at).toLocaleString() : '-');
      $('#ficha-rem').innerText = g.remitente;
      $('#ficha-dest').innerText = g.destinatario;
      $('#ficha-dir').innerText = g.direccion || '-';
      $('#ficha-obs').innerText = g.obs || '-';
      $('#ficha-peso').innerText = g.peso || '-';

      const estadoEl = $('#ficha-estado');
      estadoEl.className = 'badge-status';
      if (g.estado === 'Pendiente') estadoEl.classList.add('status-pend');
      if (g.estado === 'En tránsito') estadoEl.classList.add('status-trans');
      if (g.estado === 'Entregado') estadoEl.classList.add('status-ent');
      estadoEl.innerText = g.estado;

      $('#btn-delete-guia').dataset.id = g.id;

      // Render items
      const itemsList = $('#items-list');
      itemsList.innerHTML = '';
      const pedidos = g.pedidos || [];
      if (pedidos.length === 0) itemsList.innerHTML = '<div class="small-muted">Sin pedidos registrados.</div>';

      pedidos.forEach((it, idx) => {
        const card = document.createElement('div');
        card.className = 'd-flex align-items-center justify-content-between p-2 mb-2';
        card.style.border = '1px solid rgba(0,0,0,0.06)';
        card.style.borderRadius = '6px';
        card.innerHTML = `
          <div>
            <div><strong>${escapeHtml(it.descripcion)}</strong> <span class="small-muted">x${it.cantidad}</span></div>
            <div class="small-muted">Peso: ${it.peso||'-'} kg · Valor: ${it.valor||'-'}</div>
          </div>
          <div class="btn-group">
            <button class="btn btn-sm btn-ghost" onclick="editItem(${g.id}, ${idx})"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-danger" onclick="deleteItem(${g.id}, ${idx})"><i class="bi bi-trash"></i></button>
          </div>
        `;
        itemsList.appendChild(card);
      });

      // almacenar id actual
      $('#ficha-container').dataset.current = g.id;
    }

    async function onDeleteGuia(){
      const id = $('#ficha-container').dataset.current;
      if (!id) return;
      if (!confirm('Eliminar guía ID ' + id + '?')) return;
      await deleteGuia(Number(id));
      $('#ficha-container').style.display = 'none';
      await refreshTabla();
      await updateStats();
    }

    /* ==========================
       Items (pedidos) - modal
       ========================== */
    function openItemModal(edit=false){
      $('#item-id').value = '';
      $('#item-desc').value = '';
      $('#item-cant').value = 1;
      $('#item-valor').value = '';
      $('#item-peso').value = '';
      document.querySelector('#modalItem .modal-title').innerText = edit ? 'Editar pedido' : 'Agregar pedido';
      bsModalItem.show();
    }

    async function onSaveItem(e){
      e.preventDefault();
      const itemId = $('#item-id').value;
      const desc = $('#item-desc').value.trim();
      const cant = Number($('#item-cant').value) || 1;
      const valor = parseFloat($('#item-valor').value || 0) || 0;
      const peso = parseFloat($('#item-peso').value || 0) || 0;

      const guiaId = Number($('#ficha-container').dataset.current);
      if (!guiaId) { alert('Primero abre la ficha de una guía y luego añade pedidos.'); return; }
      const g = await getGuiaById(guiaId);
      if (!g) return alert('Guía no encontrada.');

      const item = { descripcion: desc, cantidad: cant, valor: valor || null, peso: peso || null };

      if (itemId) {
        const idx = Number(itemId);
        g.pedidos[idx] = item;
      } else {
        g.pedidos = g.pedidos || [];
        g.pedidos.push(item);
      }

      g.updated_at = new Date().toISOString();
      await putGuia(g);
      bsModalItem.hide();
      await loadFicha(guiaId);
      await refreshTabla();
      await updateStats();
    }

    async function editItem(guiaId, idx){
      const g = await getGuiaById(guiaId);
      const it = g.pedidos[idx];
      $('#item-id').value = idx;
      $('#item-desc').value = it.descripcion;
      $('#item-cant').value = it.cantidad;
      $('#item-valor').value = it.valor || '';
      $('#item-peso').value = it.peso || '';
      document.querySelector('#modalItem .modal-title').innerText = 'Editar pedido';
      bsModalItem.show();
    }

    async function deleteItem(guiaId, idx){
      if (!confirm('Eliminar pedido?')) return;
      const g = await getGuiaById(guiaId);
      g.pedidos.splice(idx,1);
      g.updated_at = new Date().toISOString();
      await putGuia(g);
      await loadFicha(guiaId);
      await refreshTabla();
      await updateStats();
    }

    /* ==========================
       Export / Import JSON (respaldo)
       ========================== */
    async function exportJSON(){
      const all = await getAllGuias();
      const data = { exported_at: new Date().toISOString(), guias: all };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'envios_backup_' + new Date().toISOString().slice(0,19).replace(/[:T]/g,'-') + '.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    async function importJSON(text){
      try {
        const parsed = JSON.parse(text);
        if (!Array.isArray(parsed.guias)) throw new Error('Formato inválido');
        for (const g of parsed.guias) {
          const toAdd = Object.assign({}, g);
          delete toAdd.id;
          try { await addGuia(toAdd); }
          catch(e){
            // si número existente, lo actualizamos
            const existing = await findGuiaByNumero(toAdd.numero);
            if (existing) {
              toAdd.id = existing.id;
              await putGuia(toAdd);
            }
          }
        }
        alert('Importación finalizada.');
        await refreshTabla();
        await updateStats();
      } catch (err){
        alert('Error importando JSON: ' + err.message);
      }
    }

    function findGuiaByNumero(numero){
      return new Promise((res, rej) => {
        const store = tx('guias','readonly');
        const idx = store.index('num');
        const r = idx.get(numero);
        r.onsuccess = ()=> res(r.result);
        r.onerror = ()=> res(null);
      });
    }

  async function exportPDFCurrent() {
  const id = Number($('#ficha-container').dataset.current);
  if (!id) return alert('Abra la ficha de una guía primero.');
  const g = await getGuiaById(id);
  if (!g) return alert('Guía no encontrada.');

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'mm', format: [100, 150] });
  const pageWidth = 100;
  const pageHeight = 150;
  const margin = 10;
  let y = 20;

  // --- Función para escribir texto largo dentro de un ancho máximo ---
  function writeText(text, x, y, maxWidth, lineHeight = 4) {
    const lines = doc.splitTextToSize(text, maxWidth);
    lines.forEach(line => {
      if (y > pageHeight - margin) { // Si llegamos al final de la página
        doc.addPage();
        y = margin;
      }
      doc.text(line, x, y);
      y += lineHeight;
    });
    return y;
  }

  // --- Logo ---
  const img = new Image();
  img.src = './img/logo.png';
  img.onload = function() {
    const imgWidth = 30;
    const imgHeight = 18;
    doc.addImage(img, "PNG", margin, 5, imgWidth, imgHeight);
  };

  // --- Encabezado ---
  doc.setFont("helvetica", "bold");
  doc.setFontSize(16);
  doc.text("GUÍA DE ENVÍO", pageWidth / 2, 15, { align: "center" });

  doc.setFont("helvetica", "normal");
  doc.setFontSize(9);
  doc.text(`Fecha: ${g.created_at ? new Date(g.created_at).toLocaleDateString() : "-"}`, pageWidth / 2, 20, { align: "center" });

  doc.setDrawColor(0);
  doc.line(margin, 25, pageWidth - margin, 25);

  // --- Sección Remitente ---
  y = 32;
  doc.setFont("helvetica", "bold");
  doc.setFontSize(11);
  doc.text("Remitente:", margin, y);
  doc.setFont("helvetica", "normal");
  y = writeText(g.remitente || "-", margin + 25, y, pageWidth - margin * 2 - 25);

  y += 2;
  doc.setFont("helvetica", "bold");
  doc.text("Dirección:", margin, y);
  doc.setFont("helvetica", "normal");
  y = writeText(g.direccion || "-", margin + 25, y, pageWidth - margin * 2 - 25);

  // --- Sección Destinatario ---
  y += 4;
  doc.setFont("helvetica", "bold");
  doc.text("Destinatario:", margin, y);
  doc.setFont("helvetica", "normal");
  y = writeText(g.destinatario || "-", margin + 25, y, pageWidth - margin * 2 - 25);

  // --- Detalles del envío (caja flexible) ---
  y += 6;
  const detailsStartY = y;
  const detailsWidth = pageWidth - 2 * margin;
  const detailsContent = [
    `Número de guía: ${g.numero}`,
    `Peso total (kg): ${g.peso || "-"}`,
    `Estado: ${g.estado}`,
    `Observaciones: ${g.obs || "-"}`
  ];

  let detailsHeight = 6; // título
  detailsContent.forEach(text => {
    const lines = doc.splitTextToSize(text, detailsWidth - 4);
    detailsHeight += lines.length * 4;
  });

  if (detailsStartY + detailsHeight > pageHeight - margin) {
    doc.addPage();
    y = margin;
  }

  doc.setDrawColor(180);
  doc.rect(margin, y - 4, detailsWidth, detailsHeight);

  doc.setFont("helvetica", "bold");
  doc.text("Detalles del envío:", margin + 2, y);
  doc.setFont("helvetica", "normal");
  y += 6;

  detailsContent.forEach(text => {
    y = writeText(text, margin + 2, y, detailsWidth - 4);
  });

  // --- Pedidos ---
  y += 6;
  doc.setFont("helvetica", "bold");
  doc.text("Pedidos:", margin, y);
  y += 4;
  doc.setFont("helvetica", "normal");

  if (!g.pedidos || g.pedidos.length === 0) {
    y = writeText("Sin pedidos registrados.", margin, y, pageWidth - 2 * margin);
  } else {
    g.pedidos.forEach((it, i) => {
      if (y > pageHeight - margin - 10) { // margen inferior
        doc.addPage();
        y = margin;
      }
      const line = `${i + 1}. ${it.descripcion} — Cant: ${it.cantidad} — Peso: ${it.peso || "-"} kg`;
      y = writeText(line, margin, y, pageWidth - 2 * margin);
    });
  }

  // --- Código de guía ---
  y += 5;
  doc.setDrawColor(0);
  doc.line(margin, y, pageWidth - margin, y);
  y += 10;

  doc.setFont("courier", "bold");
  doc.setFontSize(14);
  doc.text(`*${g.numero}*`, pageWidth / 2, y, { align: "center" });

  // --- Pie ---
  doc.setFont("helvetica", "italic");
  doc.setFontSize(8);
  y += 10;
  doc.text("Gracias por confiar en nuestro servicio", pageWidth / 2, y, { align: "center" });

  // --- Guardar PDF ---
  doc.save(`guia_${g.numero}.pdf`);
}


    /* ==========================
       Estadísticas rápidas
       ========================== */
    async function updateStats(){
      const all = await getAllGuias();
      $('#stat-total').innerText = all.length;
      $('#stat-pend').innerText = all.filter(g=> g.estado === 'Pendiente').length;
      $('#stat-trans').innerText = all.filter(g=> g.estado === 'En tránsito').length;
      $('#stat-ent').innerText = all.filter(g=> g.estado === 'Entregado').length;
    }

    /* ==========================
       Seed demo
       ========================== */
    async function seedDemo(){
      if (!confirm('Cargar datos de ejemplo (no elimina existentes)?')) return;
      const sample = [
        { numero:'GUA-2025-0001', remitente:'Venta Online S.A.', destinatario:'Clara Gómez', direccion:'Calle 123 #45-67, Bogotá', peso:2.4, estado:'Pendiente', obs:'Fragil', pedidos:[{descripcion:'Libros',cantidad:2,valor:50,peso:2}]},
        { numero:'GUA-2025-0002', remitente:'ElectroWorld', destinatario:'J. Pérez', direccion:'Carrera 10 #22-11, Medellín', peso:5.2, estado:'En tránsito', obs:'Entrega antes de 5pm', pedidos:[{descripcion:'Auriculares',cantidad:1,valor:120,peso:0.5},{descripcion:'Cargador',cantidad:1,valor:10,peso:0.2}]},
        { numero:'GUA-2025-0003', remitente:'Mercado Local', destinatario:'Ana Ramirez', direccion:'Calle 8 #3-12, Cali', peso:1.1, estado:'Entregado', obs:'Recibido por vecino', pedidos:[{descripcion:'Caja de galletas',cantidad:3,valor:15,peso:1.1}]}
      ];
      for (const s of sample) {
        try { await addGuia(Object.assign({}, s, { created_at: new Date().toISOString(), updated_at: new Date().toISOString() })); }
        catch(e){ /* si número repetido, omitir */ }
      }
      alert('Datos de ejemplo añadidos (si no existían).');
      await refreshTabla();
      await updateStats();
    }

    /* ==========================
       Confirm delete global para tabla (se usa en onclick)
       ========================== */
    // ya definido arriba como confirmDelete

    /* ==========================
       Logout
       ========================== */
    function logout(){
      localStorage.removeItem("sessionActive");
      window.location.href = "login.html";
    }

    /* ==========================
       Export: exponer funciones que se llaman desde HTML (onclick)
       ========================== */
    window.editGuia = editGuia;
    window.openFicha = openFicha;
    window.confirmDelete = confirmDelete;
    window.editItem = editItem;
    window.deleteItem = deleteItem;
    window.logout = logout;

    // Fin del IIFE
  })();
  </script>
</body>
</html>
